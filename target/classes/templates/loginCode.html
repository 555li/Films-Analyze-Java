<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>登录</title>
    <link href="css/styles.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"
            crossorigin="anonymous"></script>
</head>
<style>
    .col-lg-5 {
        opacity: .8;
    }

    .bg-primary {
        background-image: url("img/loginCodeBack.jpg");
        background-repeat: no-repeat;
        background-position: 0 0;

    }

</style>
<body class="bg-primary">
<div id="layoutAuthentication">
    <div id="layoutAuthentication_content">
        <main>
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-5">
                        <div class="card shadow-lg border-0 rounded-lg mt-5">
                            <div class="card-header"><h2 class="text-center font-weight-light my-4"
                                                         style="background:linear-gradient(pink,yellow)">
                                <img src="img/movieIndex.png" style="width: 30px;height: 30px" >
                                电影数据可视化分析系统</h2>
                                <h3 class="text-center font-weight-light my-4">验证码登录</h3></div>
                            <div class="card-body">
                                <form action="/loginByCode" method="POST">
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="inputEmail" name="email" type="email"
                                               placeholder="请输入邮箱" oninput="isEmailEmpty()"/>
                                        <div class="loginSvg">
                                            <svg t="1683168928777" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                 xmlns="http://www.w3.org/2000/svg" p-id="2584" width="16" height="16">
                                                <path d="M960.853333 903.816533a463.633067 463.633067 0 0 0-11.264-39.185066c-1.536-4.539733-3.413333-8.942933-5.051733-13.448534a484.078933 484.078933 0 0 0-9.557333-24.4736c-2.2528-5.188267-4.881067-10.274133-7.338667-15.394133-3.413333-7.099733-6.8608-14.165333-10.6496-21.0944-2.901333-5.3248-6.075733-10.513067-9.181867-15.701333-2.423467-4.061867-4.573867-8.226133-7.133866-12.219734-1.604267-2.4576-3.413333-4.778667-5.0176-7.202133-1.501867-2.218667-2.730667-4.608-4.266667-6.792533-0.4096-0.6144-1.058133-0.887467-1.501867-1.4336a461.482667 461.482667 0 0 0-90.385066-96.768c-13.5168-10.786133-27.7504-20.48-42.257067-29.5936-0.477867-0.341333-0.7168-0.8192-1.194667-1.1264-3.6864-2.286933-7.509333-4.3008-11.264-6.485334-4.266667-2.491733-8.4992-5.051733-12.868266-7.441066-6.826667-3.6864-13.789867-7.099733-20.753067-10.478934-3.618133-1.7408-7.202133-3.618133-10.8544-5.290666a449.194667 449.194667 0 0 0-31.607467-12.731734c-0.7168-0.273067-1.365333-0.6144-2.082133-0.8192-3.140267-1.1264-6.417067-1.911467-9.557333-2.935466-4.164267-1.399467-8.328533-2.833067-12.561067-4.096a259.9936 259.9936 0 0 0 129.194667-225.450667 260.061867 260.061867 0 0 0-76.629334-185.002667 259.9936 259.9936 0 0 0-185.002666-76.629333H512h-0.034133a259.857067 259.857067 0 0 0-185.002667 76.629333 259.925333 259.925333 0 0 0-76.629333 185.002667 259.584 259.584 0 0 0 76.629333 185.002667c15.906133 15.940267 33.655467 29.2864 52.565333 40.448-4.266667 1.262933-8.430933 2.730667-12.663466 4.096-3.140267 1.058133-6.3488 1.8432-9.489067 2.935466-0.7168 0.238933-1.365333 0.580267-2.048 0.8192-10.683733 3.822933-21.265067 8.0896-31.675733 12.765867-3.584 1.604267-7.0656 3.4816-10.615467 5.154133-7.099733 3.413333-14.165333 6.826667-21.0944 10.615467-4.266667 2.321067-8.3968 4.8128-12.561067 7.2704-3.822933 2.218667-7.748267 4.266667-11.502933 6.621867-0.512 0.3072-0.750933 0.8192-1.2288 1.160533-14.506667 9.147733-28.706133 18.807467-42.222933 29.559467a459.6736 459.6736 0 0 0-90.385067 96.768c-0.443733 0.546133-1.092267 0.8192-1.501867 1.4336-1.536 2.184533-2.7648 4.573867-4.266666 6.792533-1.604267 2.423467-3.447467 4.744533-5.0176 7.202133-2.56 3.9936-4.7104 8.157867-7.133867 12.219734-3.106133 5.188267-6.280533 10.376533-9.181867 15.701333-3.7888 6.929067-7.202133 13.994667-10.6496 21.0944-2.4576 5.12-5.051733 10.205867-7.338666 15.394133-3.515733 8.021333-6.519467 16.247467-9.557334 24.4736-1.672533 4.5056-3.549867 8.9088-5.051733 13.448534-4.3008 12.868267-8.0896 25.941333-11.264 39.185066-3.072 12.970667 2.594133 25.770667 13.073067 32.802134a31.3344 31.3344 0 0 0 9.966933 4.608 30.9248 30.9248 0 0 0 34.030933-15.2576 30.446933 30.446933 0 0 0 3.345067-7.7824c2.833067-11.844267 6.178133-23.483733 10.0352-34.9184 0.6144-1.8432 1.399467-3.549867 2.013867-5.358934 3.447467-9.762133 7.133867-19.456 11.332266-28.945066 0.512-1.160533 1.1264-2.2528 1.6384-3.447467 4.7104-10.308267 9.728-20.48 15.291734-30.344533l0.068266-0.1024a402.773333 402.773333 0 0 1 19.694934-31.4368l0.136533-0.375467a397.4144 397.4144 0 0 1 116.599467-111.2064c0.136533-0.1024 0.3072-0.068267 0.443733-0.170667a397.824 397.824 0 0 1 94.993067-42.973866c2.7648-0.8192 5.495467-1.7408 8.2944-2.491734 5.7344-1.604267 11.5712-3.003733 17.373866-4.334933a367.8208 367.8208 0 0 1 47.342934-7.953067c3.8912-0.443733 7.7824-0.9216 11.6736-1.2288 10.410667-0.785067 20.8896-1.3312 31.505066-1.3312s21.060267 0.546133 31.505067 1.3312c3.8912 0.3072 7.816533 0.785067 11.707733 1.2288a361.3696 361.3696 0 0 1 47.240534 7.953067c5.870933 1.3312 11.707733 2.730667 17.5104 4.334933 2.696533 0.750933 5.358933 1.6384 8.021333 2.4576 33.348267 10.103467 65.365333 24.405333 95.197867 43.008 0.136533 0.1024 0.3072 0.068267 0.443733 0.170667a396.151467 396.151467 0 0 1 116.599467 111.2064c0.1024 0.136533 0.1024 0.273067 0.170666 0.375467 13.687467 19.7632 25.3952 40.5504 35.191467 62.1568l1.467733 3.037866c4.3008 9.659733 8.055467 19.592533 11.605334 29.5936 0.546133 1.604267 1.2288 3.106133 1.774933 4.7104 3.822933 11.4688 7.236267 23.176533 10.0352 35.0208a31.061333 31.061333 0 0 0 60.450133-14.336z m-249.275733-560.2304A199.850667 199.850667 0 0 1 512 543.197867a199.850667 199.850667 0 0 1-199.5776-199.611734A199.816533 199.816533 0 0 1 512 144.008533a199.816533 199.816533 0 0 1 199.5776 199.5776z"
                                                      fill="#272636" p-id="2585">
                                                </path>
                                            </svg>
                                        </div>
                                        <label for="inputEmail">邮箱</label>
                                        <span id="emailSpan" class="from-span"></span>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="inputCode" name="code" type="text"
                                               placeholder="请输入验证码" oninput="checkCode()"/>
                                        <label for="inputCode">验证码</label>
                                        <span id="codeSpan" class="from-span"></span>
                                        <div class="loginSvg">
                                            <svg t="1683169454575" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                 xmlns="http://www.w3.org/2000/svg" p-id="2992" width="16" height="16">
                                                <path d="M727.78 388.5h-14.61a1 1 0 0 1-1-1v-73.75a200.48 200.48 0 0 0-56.91-140.59 196 196 0 0 0-108.46-57c-123.52-21.31-236 75.32-236 200.62v70.72a1 1 0 0 1-1 1h-12.93a102.44 102.44 0 0 0-102.43 102.44v317.22a102.42 102.42 0 0 0 102.43 102.42h429.8A102.42 102.42 0 0 0 829.1 808.16V489.93A101.27 101.27 0 0 0 727.78 388.5zM358.9 313.75c0-91.83 60.82-152.53 152.54-152.53 45 0 78.88 14.06 109.45 45.52 29.91 30.8 43.07 63.82 43.07 107v73.76a1 1 0 0 1-1 1h-303a1 1 0 0 1-1-1z m422.34 495.41c0 35.71-17.75 53.45-53.46 53.45H297a54.45 54.45 0 0 1-54.45-54.45V498.41a61.81 61.81 0 0 1 61.81-61.81h422.31a54.45 54.45 0 0 1 54.45 54.45v318.11z m0 0"
                                                      p-id="2993">
                                                </path>
                                                <path d="M510 570.38c-17.07 0-22.31 12.72-22.31 22.87V691c0 10.15 10 18.41 22.31 18.41s22.3-8.26 22.3-18.41v-97.75c0-10.15-7.81-22.87-22.32-22.87z m0 0"
                                                      p-id="2994">
                                                </path>
                                            </svg>
                                        </div>
                                        <center>
                                            <button type="button" class="codebtn codebtn-default" id="sendCodeBtn"
                                                    onclick="getCode()" disabled>获取验证码
                                            </button>
                                        </center>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mt-4 mb-0">
                                        <button style="width: 100%;" class="btn btn-primary" type="submit"
                                                onclick="submitCheck()">登录
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="card-footer text-center py-3">
                                <div class="small"><a class="a" href="/login">使用密码登录</a>
                                    <span style="margin-left:30px;margin-right:30px"></span>
                                    <a class="a" href="/registry">还没有账号? 注册!</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<script src="/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script src="/js/jquery-3.6.4.min.js"></script>
<script src="/js/scripts.js"></script>
<script type="text/javascript">

    var codes = "";
    var emailChecked = false;
    var codeChecked = false;
    $("#sendCodeBtn").prop("disabled", true);


    //判断邮箱格式
    function isEmailEmpty() {
        var email = document.getElementsByName("email")[0].value;
        var emailSpan = document.getElementById("emailSpan");


        if (email.length == 0 || email == null) {
            emailSpan.innerHTML = '<font style="color: red">❗</font>';
            emailChecked = false;
            $("#sendCodeBtn").prop("disabled", true);
        } else {
            $("#sendCodeBtn").prop("disabled", false);
            let reg = /^[a-zA-Z0-9]+([-_.][A-Za-zd]+)*@([a-zA-Z0-9]+[-.])+[A-Za-zd]{2,5}$/
            if (!reg.test(email)) {
                emailSpan.innerHTML = '<font style="color: red">❗</font>';
                emailChecked = false;
            } else {
                emailSpan.innerHTML = '<font style="color: green">✔</font>';
                emailChecked = true;
            }
        }

    }

    //生成验证码
    function createCode() {
        // 生成验证码的函数
        //验证码的初始值
        var code = ""
        var codeLength = 4;   //验证码的长度
        // 验证码的组成成分
        var codeChars = new Array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'a', 'b', 'c', 'd', 'e', 'f',
            'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w',
            'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N',
            'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z');
        for (var i = 0; i < codeLength; i++) {
            // 获取随机数：下标
            var charNum = Math.floor(Math.random() * 62);
            // 验证码
            code += codeChars[charNum];
        }
        return code;
    }

    //发送验证码
    function getCode() {
        var email = document.getElementById("inputEmail").value;
        //获取发送验证码的按钮
        const sendCodeBtn = document.getElementById("sendCodeBtn");
        if (email == null || email.length == 0) {
            alert("请先输入邮箱")
        }
        code = createCode();
        codes = code;
        datas = {
            'code': code,
            'email': email
        },
            $.ajax({
                type: 'POST',
                url: '/sendCode',
                data: JSON.stringify(datas),
                dataType: 'json',
                contentType: "application/json;charset=UTF-8",
                success: function (response) {
                    sendCodeBtn.disabled = true;
                    let count = 60;
                    sendCodeBtn.innerHTML = count + '秒后重新发送';
                    const timer = setInterval(() => {
                        count--;
                        sendCodeBtn.innerHTML = count + '秒后重新发送';
                        if (count === 0) {
                            clearInterval(timer);
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '发送验证码';
                        }
                    }, 1000);
                },

            })
    }

    //检查验证码
    function checkCode() {
        var inputcode = document.getElementById("inputCode").value;
        var codeSpan = document.getElementById('codeSpan');
        if (inputcode == null || inputcode.length == 0) {
            codeSpan.innerHTML = '<font style="color: red">❗</font>';
            codeChecked = false;
        } else if (codes != inputcode) {
            codeSpan.innerHTML = '<font style="color: red">×</font>';
            codeChecked = false;
        } else {
            codeSpan.innerHTML = '<font style="color: green">✔</font>';
            codeChecked = true;
        }
    }

    //提交时判断
    function submitCheck() {
        event.preventDefault();
        var form = document.querySelector('form');
        if (!emailChecked) {
            alert("请输入邮箱！")
        }
        if (!codeChecked) {
            alert("请输入验证码或检查验证码是否正确！")
        } else if (emailChecked & codeChecked) {
            form.submit()
        }
    }


</script>
</body>
</html>
